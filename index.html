<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>軒揚數理教師打卡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-effect { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .punch-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .punch-btn:active { transform: scale(0.95); opacity: 0.9; }
        .gradient-bg { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        
        @keyframes modalIn {
            0% { opacity: 0; transform: scale(0.9) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes modalOut {
            0% { opacity: 1; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(0.9) translateY(-20px); }
        }
        .animate-modal-in { animation: modalIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-modal-out { animation: modalOut 0.2s ease-in forwards; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        button svg, button span { pointer-events: none; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-slate-900">

    <!-- 狀態列 -->
    <nav class="fixed top-0 inset-x-0 z-40 px-6 py-6 flex justify-between items-center">
        <div class="flex items-center gap-2 glass-effect px-4 py-2 rounded-full border border-white shadow-sm">
            <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-slate-300"></div>
            <span id="statusText" class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">定位初始化...</span>
        </div>
        <button id="navAdminBtn" class="w-10 h-10 glass-effect rounded-full flex items-center justify-center text-slate-500 border border-white shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
        </button>
    </nav>

    <!-- 主打卡畫面 -->
    <main id="punchView" class="max-w-md mx-auto pt-28 pb-10 px-6 space-y-10">
        <div class="text-center space-y-1">
            <h1 class="text-5xl font-black tracking-tighter text-slate-800">軒揚數理</h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.4em]">教師打卡系統</p>
        </div>

        <div class="space-y-6">
            <div class="space-y-2 relative">
                <label class="px-4 text-[10px] font-black text-slate-400 tracking-widest uppercase">Teacher Name</label>
                <input id="teacherName" type="text" placeholder="輸入姓名" class="w-full glass-effect p-6 rounded-[2rem] text-xl font-bold border-2 border-transparent shadow-xl outline-none">
                <div id="nameError" class="hidden absolute left-5 -bottom-6 text-rose-500 text-xs font-bold">請輸入教師姓名</div>
            </div>

            <div class="space-y-2">
                <label class="px-4 text-[10px] font-black text-slate-400 tracking-widest uppercase">Location</label>
                <div class="flex gap-3">
                    <select id="locationSelect" class="flex-1 glass-effect p-6 rounded-[2rem] text-lg font-bold border border-white shadow-inner outline-none appearance-none bg-transparent"></select>
                    <button id="addLocBtn" class="w-16 h-16 bg-blue-600 text-white rounded-[1.8rem] flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" /></svg>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-5 pt-4">
                <button id="punchInBtn" class="punch-btn bg-emerald-500 text-white p-10 rounded-[2.5rem] font-black text-2xl shadow-xl">上班打卡</button>
                <button id="punchOutBtn" class="punch-btn bg-slate-900 text-white p-10 rounded-[2.5rem] font-black text-2xl shadow-xl">下班打卡</button>
            </div>
        </div>
    </main>

    <!-- 成功與反饋提示 -->
    <div id="successOverlay" class="hidden fixed inset-0 z-[200] flex items-center justify-center px-8 bg-slate-900/60 backdrop-blur-md">
        <div id="successCard" class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl transition-all">
            <div id="successIcon" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6"></div>
            <h3 id="successTitle" class="text-3xl font-black text-slate-800 mb-2"></h3>
            <p id="successTeacher" class="text-xl font-bold text-slate-600"></p>
        </div>
    </div>

    <!-- 管理登入介面 -->
    <section id="authView" class="hidden fixed inset-0 z-50 bg-white/95 backdrop-blur-md flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h3 class="font-black text-2xl mb-8 uppercase tracking-widest text-slate-400">Admin Authentication</h3>
            <input id="adminPass" type="password" placeholder="密碼" class="w-full bg-slate-100 p-6 rounded-2xl text-center text-4xl outline-none mb-8">
            <div class="flex gap-4">
                <button id="authBackBtn" class="flex-1 font-bold text-slate-400">返回</button>
                <button id="authLoginBtn" class="flex-[2] py-5 bg-blue-600 text-white rounded-2xl font-black shadow-lg">登入</button>
            </div>
        </div>
    </section>

    <!-- 後台管理頁面 -->
    <section id="adminView" class="hidden max-w-2xl mx-auto pt-28 p-6 pb-32">
        <div class="flex justify-between items-end mb-8">
            <h2 class="text-4xl font-black italic text-slate-800 underline decoration-blue-500">HISTORY</h2>
            <div class="flex gap-2">
                <button id="adminManualAddBtn" class="px-4 py-2 bg-emerald-500 text-white text-[10px] font-black rounded-full shadow-lg">補登紀錄</button>
                <button id="adminLogoutBtn" class="px-4 py-2 bg-slate-800 text-white text-[10px] font-black rounded-full">登出</button>
            </div>
        </div>
        <div id="teacherTabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-4 border-b border-slate-200"></div>
        <div id="logList" class="space-y-4 py-6"></div>
    </section>

    <!-- 編輯 Modal -->
    <div id="editModal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-slate-900/80">
        <div id="editModalContent" class="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-4 shadow-2xl">
            <h3 id="editModalTitle" class="text-xl font-black">編輯紀錄</h3>
            <input id="editId" type="hidden">
            <div class="space-y-4">
                <input id="editName" type="text" placeholder="老師姓名" class="w-full p-4 bg-slate-50 rounded-xl border font-bold outline-none">
                <select id="editLoc" class="w-full p-4 bg-slate-50 rounded-xl border font-bold"></select>
                <div class="grid grid-cols-2 gap-2">
                    <select id="editType" class="w-full p-4 bg-slate-50 rounded-xl border font-bold">
                        <option value="上班打卡">上班打卡</option>
                        <option value="下班打卡">下班打卡</option>
                    </select>
                    <input id="editTime" type="datetime-local" class="w-full p-4 bg-slate-50 rounded-xl border text-xs font-bold">
                </div>
            </div>
            <div id="editBtnGroup" class="flex flex-col gap-2 pt-4">
                <button id="doSaveBtn" class="w-full py-4 bg-blue-600 text-white rounded-xl font-black shadow-lg">儲存修改</button>
                <button id="preDeleteBtn" class="w-full py-2 text-rose-500 font-bold">刪除紀錄</button>
                <button id="confirmDeleteBtn" class="hidden w-full py-4 bg-rose-600 text-white rounded-xl font-black shadow-lg">確認刪除 (不可還原)</button>
                <button id="closeEditBtn" class="w-full py-2 text-slate-400">取消</button>
            </div>
        </div>
    </div>

    <!-- 地點新增 Modal -->
    <div id="locModal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-slate-900/80">
        <div id="locModalContent" class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 text-center space-y-4 shadow-2xl">
            <h3 class="text-xl font-black text-slate-800">新增地點</h3>
            <input id="newLocInput" type="text" placeholder="地點名稱" class="w-full p-4 bg-slate-50 rounded-xl border text-center font-bold outline-none">
            <div class="flex gap-2">
                <button id="closeLocBtn" class="flex-1 text-slate-400 font-bold">取消</button>
                <button id="confirmLocBtn" class="flex-1 py-4 bg-blue-600 text-white rounded-xl font-black">新增</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-iTmN_rwJUWbNmbBiXva52dlNKyM4fSA",
            authDomain: "lmteam-4f2db.firebaseapp.com",
            projectId: "lmteam-4f2db",
            storageBucket: "lmteam-4f2db.firebasestorage.app",
            messagingSenderId: "765459964596",
            appId: "1:765459964596:web:6e1898716b1e860952d7e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const PATH = 'sy-production-geo-v1';
        
        // 關鍵修正：確保所有地方使用的路徑完全一致
        const getCollectionRef = () => collection(db, 'artifacts', PATH, 'public', 'data', 'attendance');

        let logs = [];
        let filterT = 'ALL';
        let currentGeo = null;
        const PRESET = ['文星文理補習班（大社吉的堡）', '鳳翔文理補習班', '麥克亞綸文理補習班'];
        let activeLocs = JSON.parse(localStorage.getItem('sy_locs_geo')) || PRESET;

        const hide = (id) => document.getElementById(id)?.classList.add('hidden');
        const show = (id) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('hidden');
            const content = document.getElementById(id + 'Content');
            if (content) {
                content.classList.remove('animate-modal-out');
                content.classList.add('animate-modal-in');
            }
        };

        function switchView(viewName) {
            ['punchView', 'authView', 'adminView'].forEach(hide);
            const isVerified = sessionStorage.getItem('sy_admin_verified') === 'true';
            if (viewName === 'admin' && !isVerified) show('authView');
            else show(viewName + 'View');
            if (viewName === 'admin') renderAdmin();
        }

        function refreshLocUI(selectedValue = null) {
            const options = activeLocs.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('locationSelect').innerHTML = options;
            document.getElementById('editLoc').innerHTML = options;
            if (selectedValue) {
                document.getElementById('locationSelect').value = selectedValue;
                document.getElementById('editLoc').value = selectedValue;
            }
        }

        function showFeedback(teacher, title, mode = "success") {
            const overlay = document.getElementById('successOverlay');
            const card = document.getElementById('successCard');
            const iconWrap = document.getElementById('successIcon');
            
            iconWrap.className = `w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 ${mode === 'delete' ? 'bg-rose-100 text-rose-500' : 'bg-emerald-100 text-emerald-500'}`;
            iconWrap.innerHTML = mode === 'delete' ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7" /></svg>`;

            document.getElementById('successTitle').innerText = title;
            document.getElementById('successTeacher').innerText = teacher ? `${teacher} 老師` : "";
            overlay.classList.remove('hidden');
            card.classList.add('animate-modal-in');
            
            setTimeout(() => {
                card.classList.replace('animate-modal-in', 'animate-modal-out');
                setTimeout(() => { overlay.classList.add('hidden'); card.classList.remove('animate-modal-out'); }, 300);
            }, 1500);
        }

        document.getElementById('navAdminBtn').onclick = () => switchView('admin');
        document.getElementById('authBackBtn').onclick = () => switchView('punch');
        document.getElementById('addLocBtn').onclick = () => show('locModal');
        document.getElementById('closeLocBtn').onclick = () => hide('locModal');
        document.getElementById('adminLogoutBtn').onclick = () => { sessionStorage.removeItem('sy_admin_verified'); location.reload(); };
        document.getElementById('adminManualAddBtn').onclick = () => openEditModal(null);
        document.getElementById('closeEditBtn').onclick = () => hide('editModal');

        document.getElementById('confirmLocBtn').onclick = () => {
            const v = document.getElementById('newLocInput').value.trim();
            if (v && !activeLocs.includes(v)) {
                activeLocs.push(v);
                localStorage.setItem('sy_locs_geo', JSON.stringify(activeLocs));
                refreshLocUI(v);
            }
            hide('locModal');
            document.getElementById('newLocInput').value = "";
        };

        document.getElementById('authLoginBtn').onclick = () => {
            if (document.getElementById('adminPass').value === "860201") {
                sessionStorage.setItem('sy_admin_verified', 'true');
                switchView('admin');
            } else alert("密碼錯誤");
        };

        document.getElementById('punchInBtn').onclick = () => handlePunch('上班打卡');
        document.getElementById('punchOutBtn').onclick = () => handlePunch('下班打卡');

        document.getElementById('doSaveBtn').onclick = async () => {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value.trim();
            if (!name) return alert("請輸入姓名");
            
            const payload = {
                teacher: name,
                location: document.getElementById('editLoc').value,
                type: document.getElementById('editType').value,
                clientTime: new Date(document.getElementById('editTime').value).toISOString()
            };

            hide('editModal');
            try {
                if (id) {
                    const docRef = doc(db, 'artifacts', PATH, 'public', 'data', 'attendance', id);
                    await updateDoc(docRef, payload);
                    showFeedback(name, "修改成功");
                } else {
                    payload.timestamp = serverTimestamp();
                    payload.geo = "手動補登";
                    await addDoc(getCollectionRef(), payload);
                    showFeedback(name, "補登成功");
                }
            } catch (e) { console.error(e); }
        };

        document.getElementById('preDeleteBtn').onclick = () => {
            document.getElementById('preDeleteBtn').classList.add('hidden');
            document.getElementById('doSaveBtn').classList.add('hidden');
            document.getElementById('confirmDeleteBtn').classList.remove('hidden');
        };

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            if (!id) return;
            try {
                hide('editModal');
                const docRef = doc(db, 'artifacts', PATH, 'public', 'data', 'attendance', id);
                await deleteDoc(docRef);
                showFeedback(name, "紀錄已刪除", "delete");
            } catch (e) { console.error(e); }
        };

        async function handlePunch(type) {
            const nameEl = document.getElementById('teacherName');
            const name = nameEl.value.trim();
            if (!name) { nameEl.classList.add('border-rose-400'); show('nameError'); return; }
            nameEl.classList.remove('border-rose-400'); hide('nameError');
            
            showFeedback(name, `${type}成功`);
            try {
                await addDoc(getCollectionRef(), {
                    teacher: name,
                    location: document.getElementById('locationSelect').value,
                    type,
                    geo: currentGeo || "無定位資訊",
                    timestamp: serverTimestamp(),
                    clientTime: new Date().toISOString()
                });
                localStorage.setItem('sy_name_geo', name);
            } catch (e) { console.error(e); }
        }

        function openEditModal(id) {
            const data = id ? logs.find(l => l.id === id) : null;
            document.getElementById('editId').value = id || '';
            document.getElementById('editModalTitle').innerText = id ? "編輯紀錄" : "補登紀錄";
            document.getElementById('editName').value = data ? data.teacher : "";
            document.getElementById('editLoc').value = data ? data.location : activeLocs[0];
            document.getElementById('editType').value = data ? data.type : "上班打卡";
            
            const d = data ? new Date(data.clientTime) : new Date();
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            document.getElementById('editTime').value = d.toISOString().slice(0, 16);
            
            document.getElementById('preDeleteBtn').classList.toggle('hidden', !id);
            document.getElementById('doSaveBtn').classList.remove('hidden');
            document.getElementById('confirmDeleteBtn').classList.add('hidden');
            show('editModal');
        }

        function renderAdmin() {
            const list = document.getElementById('logList');
            if (!list) return;
            const tNames = [...new Set(logs.map(l => l.teacher))];
            
            document.getElementById('teacherTabs').innerHTML = `<button data-t="ALL" class="tab-btn whitespace-nowrap px-4 py-2 text-sm font-black ${filterT === 'ALL' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'}">全部</button>` + 
                tNames.map(t => `<button data-t="${t}" class="tab-btn whitespace-nowrap px-4 py-2 text-sm font-black ${filterT === t ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'}">${t}</button>`).join('');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => { filterT = b.dataset.t; renderAdmin(); });

            const filtered = filterT === 'ALL' ? logs : logs.filter(l => l.teacher === filterT);
            list.innerHTML = filtered.length ? filtered.map(log => `
                <div class="glass-effect p-6 rounded-[2rem] border border-white shadow-sm flex justify-between items-center">
                    <div class="space-y-1">
                        <div class="font-black text-slate-800">${log.teacher} <span class="text-[10px] font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">${log.type}</span></div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">${log.location}</div>
                        <div class="text-[9px] text-slate-300 font-mono">${new Date(log.clientTime).toLocaleString('zh-TW', {hour12:false})}</div>
                    </div>
                    <button class="edit-trigger text-xs text-blue-500 font-black px-4 py-3 bg-blue-50 rounded-2xl active:scale-95 transition-transform" data-id="${log.id}">修正</button>
                </div>`).join('') : '<div class="text-center py-20 text-slate-300 font-bold">目前尚無歷史紀錄</div>';
            
            document.querySelectorAll('.edit-trigger').forEach(b => b.onclick = () => openEditModal(b.dataset.id));
        }

        (async () => {
            try {
                await signInAnonymously(auth);
                
                // 核心同步邏輯：確保即時監聽並更新全域 logs
                onSnapshot(getCollectionRef(), (snap) => {
                    logs = [];
                    snap.forEach(d => logs.push({ id: d.id, ...d.data() }));
                    // 依時間由新到舊排序
                    logs.sort((a, b) => new Date(b.clientTime) - new Date(a.clientTime));
                    
                    // 如果目前人在後台，即時重新渲染列表
                    if (sessionStorage.getItem('sy_admin_verified') === 'true') {
                        renderAdmin();
                    }
                }, (err) => console.error("Snapshot Error:", err));

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(pos => {
                        currentGeo = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: Math.round(pos.coords.accuracy) };
                        const dot = document.getElementById('statusDot');
                        dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
                        document.getElementById('statusText').innerText = `定位中 (誤差${currentGeo.accuracy}m)`;
                    });
                }

                refreshLocUI();
                const last = localStorage.getItem('sy_name_geo');
                if (last) document.getElementById('teacherName').value = last;
                if (sessionStorage.getItem('sy_admin_verified') === 'true') switchView('admin');

            } catch (e) { console.error("Init Error:", e); }
        })();
    </script>
</body>
</html>
